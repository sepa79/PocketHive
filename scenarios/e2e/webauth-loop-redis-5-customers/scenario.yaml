id: webauth-loop-redis-5-customers
name: WebAuth Loop (5 Customers, Shared BAL/TOP)
description: Two-input loop for five customers. Main input reads RED per customer, secondary input reads shared BAL/TOP lists in round-robin. Flow is RED.<customer> -> BAL.shared -> TOP.shared -> RED.<customer>.
template:
  image: swarm-controller:latest
  bees:
    - role: generator
      image: generator:latest
      config:
        inputs:
          type: REDIS_DATASET
          redis:
            host: redis
            port: 6379
            sources:
              # WEIGHTED_RANDOM uses relative weights, not percentages.
              # Values do NOT need to sum to 100 (40/25/15/12/8 works the same as 4/2.5/1.5/1.2/0.8).
              # Effective probability is weight_i / sum(all weights), so here:
              # - custA ~ 40%
              # - custB ~ 25%
              # - custC ~ 15%
              # - custD ~ 12%
              # - custE ~ 8%
              - listName: webauth.RED.custA
                weight: 40
              - listName: webauth.RED.custB
                weight: 25
              - listName: webauth.RED.custC
                weight: 15
              - listName: webauth.RED.custD
                weight: 12
              - listName: webauth.RED.custE
                weight: 8
            pickStrategy: WEIGHTED_RANDOM
            ratePerSec: 20
        worker:
          message:
            bodyType: SIMPLE
            body: "{{ payload }}"
            headers:
              content-type: application/json
              x-ph-service-id: webauth
              x-ph-call-id: webauth-loop-5
      work:
        out:
          out: build

    - role: generator
      image: generator:latest
      config:
        inputs:
          type: REDIS_DATASET
          redis:
            host: redis
            port: 6379
            sources:
              - listName: webauth.BAL.shared
                weight: 1
              - listName: webauth.TOP.shared
                weight: 1
            pickStrategy: ROUND_ROBIN
            ratePerSec: 20
        worker:
          message:
            bodyType: SIMPLE
            body: "{{ payload }}"
            headers:
              content-type: application/json
              x-ph-service-id: webauth
              x-ph-call-id: webauth-loop-5
      work:
        out:
          out: build

    - role: request-builder
      image: request-builder:latest
      config:
        templateRoot: /app/scenario/templates/http
        serviceId: webauth
        passThroughOnMissingTemplate: false
      work:
        in:
          in: build
        out:
          out: proc

    - role: processor
      image: processor:latest
      config:
        baseUrl: "{{ sut.endpoints['webauth'].baseUrl }}"
        outputs:
          type: RABBITMQ
      work:
        in:
          in: proc
        out:
          out: post

    - role: postprocessor
      image: postprocessor:latest
      config:
        outputs:
          type: REDIS
          redis:
            host: redis
            port: 6379
            sourceStep: FIRST
            pushDirection: RPUSH
            routes:
              - header: x-ph-redis-list
                headerMatch: '^webauth\\.RED\\.cust[A-E]$'
                list: webauth.BAL.shared
              - header: x-ph-redis-list
                headerMatch: '^webauth\\.BAL\\.shared$'
                list: webauth.TOP.shared
            targetListTemplate: "webauth.RED.{{ payloadAsJson.Customer }}"
      work:
        in:
          in: post
