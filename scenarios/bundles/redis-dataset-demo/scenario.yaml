id: redis-dataset-demo
name: Redis dataset demo (generator + per-customer lists)
description: Seeds Redis with randomised payloads, executes template-driven HTTP calls, and persists extracted transaction outcomes to ClickHouse from postprocessor.
template:
  image: swarm-controller:latest
  bees:
    - role: generator
      image: generator:latest
      config:
        outputs:
          type: NONE
        inputs:
          type: SCHEDULER
          scheduler:
            ratePerSec: 5
        worker:
          message:
            bodyType: SIMPLE
            body: |
              {% set cust = pickWeighted('custA', 1, 'custB', 1) %}
              {% set card = eval("#randLong('4000000000000000','4999999999999999')") %}
              {"customerCode":"{{ cust }}",
              "accountNumber":"{{ eval('#randInt(10000000,99999999)') }}",
              "cardNumber":"{{ card }}",
              "nonce":"{{ eval('#uuid()') }}"}
        interceptors:
          redisUploader:
            enabled: true
            host: redis
            port: 6379
            phase: AFTER
            sourceStep: LAST
            pushDirection: RPUSH
            routes:
              - match: '"customerCode"\s*:\s*"custA"'
                list: ph:dataset:custa
              - match: '"customerCode"\s*:\s*"custB"'
                list: ph:dataset:custb
            fallbackList: ph:dataset:other
      work: {}

    - role: dataProviderA
      image: generator:latest
      config:
        inputs:
          type: REDIS_DATASET
          redis:
            host: redis
            port: 6379
            listName: ph:dataset:custa
            ratePerSec: 5
        worker:
          message:
            bodyType: SIMPLE
            body: "{{ payload }}"
            headers:
              content-type: application/json
              x-ph-call-id: "{{ pickWeighted('redis-auth', 50, 'redis-balance', 30, 'redis-topup', 20) }}"
      work:
        out: http-build

    - role: dataProviderB
      image: generator:latest
      config:
        inputs:
          type: REDIS_DATASET
          redis:
            host: redis
            port: 6379
            listName: ph:dataset:custb
            ratePerSec: 5
        worker:
          message:
            bodyType: SIMPLE
            body: "{{ payload }}"
            headers:
              content-type: application/json
              x-ph-call-id: "{{ pickWeighted('redis-balance', 40, 'redis-topup', 40, 'redis-auth', 20) }}"
      work:
        out: http-build

    - role: http-builder
      image: http-builder:latest
      config:
        worker:
          templateRoot: /app/scenario/http-templates
          serviceId: default
      work:
        in: http-build
        out: proc

    - role: processor
      image: processor:latest
      config:
        baseUrl: "{{ sut.endpoints['default'].baseUrl }}"
      work:
        in: proc
        out: post

    - role: postprocessor
      image: postprocessor:latest
      env:
        POCKETHIVE_SINK_CLICKHOUSE_ENDPOINT: http://clickhouse:8123
        POCKETHIVE_SINK_CLICKHOUSE_TABLE: ph_tx_outcome_v1
        POCKETHIVE_SINK_CLICKHOUSE_USERNAME: pockethive
        POCKETHIVE_SINK_CLICKHOUSE_PASSWORD: pockethive
      config:
        worker:
          forwardToOutput: false
          writeTxOutcomeToClickHouse: true
          dropTxOutcomeWithoutCallId: true
      work:
        in: post
