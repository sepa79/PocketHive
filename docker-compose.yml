version: "3.9"
services:
  rabbitmq:
    build:
      context: .
      dockerfile: Dockerfile.rabbit
    environment: {}
    ports:
      - "5672:5672"
      - "15672:15672"
      - "15674:15674"
    healthcheck:
      test: ["CMD-SHELL", "nc -z 127.0.0.1 5672"]
      interval: 5s
      timeout: 10s
      retries: 24
      start_period: 30s

  orchestrator:
    build:
      context: .
      dockerfile: orchestrator-service/Dockerfile
    environment:
      RABBITMQ_HOST: rabbitmq
      PH_CONTROL_EXCHANGE: ph.control
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      rabbitmq:
        condition: service_healthy
      log-aggregator:
        condition: service_healthy

  swarm-controller:
    profiles: ["bees"]
    build:
      context: .
      dockerfile: swarm-controller-service/Dockerfile
    environment:
      RABBITMQ_HOST: rabbitmq
      PH_CONTROL_EXCHANGE: ph.control
      PH_CONTROL_QUEUE: ph.control
      PH_SWARM_ID: swarm1
    depends_on:
      log-aggregator:
        condition: service_healthy

  generator:
    profiles: ["bees"]
    build:
      context: .
      dockerfile: generator-service/Dockerfile
    environment:
      RABBITMQ_HOST: rabbitmq
      PH_TRAFFIC_EXCHANGE: ph.swarm1.hive
      PH_CONTROL_QUEUE: ph.control
      PH_SWARM_ID: swarm1
    depends_on:
      log-aggregator:
        condition: service_healthy

  moderator:
    profiles: ["bees"]
    build:
      context: .
      dockerfile: moderator-service/Dockerfile
    environment:
      RABBITMQ_HOST: rabbitmq
      PH_TRAFFIC_EXCHANGE: ph.swarm1.hive
      PH_CONTROL_QUEUE: ph.control
      PH_SWARM_ID: swarm1
    depends_on:
      log-aggregator:
        condition: service_healthy

  processor:
    profiles: ["bees"]
    build:
      context: .
      dockerfile: processor-service/Dockerfile
    environment:
      RABBITMQ_HOST: rabbitmq
      PH_TRAFFIC_EXCHANGE: ph.swarm1.hive
      PH_CONTROL_QUEUE: ph.control
      PH_SWARM_ID: swarm1
    depends_on:
      log-aggregator:
        condition: service_healthy

  postprocessor:
    profiles: ["bees"]
    build:
      context: .
      dockerfile: postprocessor-service/Dockerfile
    environment:
      RABBITMQ_HOST: rabbitmq
      PH_TRAFFIC_EXCHANGE: ph.swarm1.hive
      PH_CONTROL_QUEUE: ph.control
      PH_SWARM_ID: swarm1
    depends_on:
      log-aggregator:
        condition: service_healthy

  trigger:
    profiles: ["bees"]
    build:
      context: .
      dockerfile: trigger-service/Dockerfile
    environment:
      RABBITMQ_HOST: rabbitmq
      PH_TRAFFIC_EXCHANGE: ph.swarm1.hive
      PH_CONTROL_QUEUE: ph.control
      PH_SWARM_ID: swarm1
    depends_on:
      log-aggregator:
        condition: service_healthy

  scenario-manager:
    build:
      context: .
      dockerfile: scenario-manager-service/Dockerfile
    environment:
      RABBITMQ_HOST: rabbitmq
      PH_LOGS_QUEUE: ph.logs.agg
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:8080/actuator/health | grep -q UP"]
      interval: 5s
      timeout: 10s
      retries: 10
      start_period: 30s
    ports:
      - "1081:8080"
    depends_on:
      log-aggregator:
        condition: service_healthy

  log-aggregator:
    build:
      context: .
      dockerfile: log-aggregator-service/Dockerfile
    environment:
      RABBITMQ_HOST: rabbitmq
      PH_LOGS_EXCHANGE: ph.logs
      PH_LOGS_QUEUE: ph.logs.agg
      PH_LOKI_URL: http://loki:3100
    depends_on:
      rabbitmq:
        condition: service_started
      loki:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:8080/actuator/health | grep -q UP"]
      interval: 5s
      timeout: 10s
      retries: 10
      start_period: 30s
    ports:
      - "1080:8080"

  ui:
    build:
      context: .
      dockerfile: ui/Dockerfile
      args:
        VITE_STOMP_READONLY_USER: ${VITE_STOMP_READONLY_USER:-ph-observer}
        VITE_STOMP_READONLY_PASSCODE: ${VITE_STOMP_READONLY_PASSCODE:-ph-observer}
    depends_on:
      scenario-manager:
        condition: service_healthy
    ports:
      - "8088:80"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1/healthz | grep -q ok"]
      interval: 10s
      timeout: 5s
      retries: 6
      start_period: 5s

  prometheus:
    image: prom/prometheus
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "9090:9090"

  grafana:
    image: grafana/grafana
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
      - loki

  loki:
    image: grafana/loki:2.9.1
    command: -config.file=/etc/loki/config.yml
    ports:
      - "3100:3100"
    volumes:
      - ./loki/config.yml:/etc/loki/config.yml:ro

  wiremock:
    image: wiremock/wiremock:3.13.1
    command:
      [
        "--verbose",                          # useful logs for debugging
        "--disable-banner",                   # cleaner output
        "--async-response-enabled",           # enable async responses (better throughput)
        "--global-response-templating",       # allows templating across all stubs
        "--record-mappings",                  # auto-record mappings (if needed for tests)
        # "--no-request-journal",             # disable detailed journaling for perf (optional, see note below)
        "--max-request-journal-entries=1000", # avoid memory blowup, keep it reasonable
        "--enable-stub-cors",                # allow cross-origin access
      ]
    environment:
      LANG: en_US.UTF-8
      JAVA_OPTS: >-
        -XX:+UseG1GC
        -XX:+ParallelRefProcEnabled
        -XX:MaxRAMPercentage=75
        -XX:+HeapDumpOnOutOfMemoryError
        -Djava.net.preferIPv4Stack=true
        -Djava.awt.headless=true
    ports:
      - "8080:8080"
    volumes:
      - ./wiremock/mappings:/home/wiremock/mappings
      - ./wiremock/__files:/home/wiremock/__files

  # promtail:
  #   # disabled: logs are shipped via RabbitMQ and aggregated to Loki
  #   image: grafana/promtail:2.9.1
  #   command: -config.file=/etc/promtail/config.yml
  #   ports:
  #     - "9080:9080"
  #   volumes:
  #     - ./promtail/config.yml:/etc/promtail/config.yml:ro
  #     - /var/lib/docker/containers:/var/lib/docker/containers:ro
  #     - /var/run/docker.sock:/var/run/docker.sock:ro
  #   depends_on:
  #     - loki
