<configuration>
  <include resource="org/springframework/boot/logging/logback/base.xml"/>

  <!-- Scenario manager does not participate in the control-plane routing, so the log identifiers are constant. -->
  <property scope="context" name="roleIdentifier" value="scenario-manager"/>
  <property scope="context" name="swarmIdentifier" value="default"/>
  <property scope="context" name="instanceIdentifier" value="scenario-manager"/>

  <logger name="org.springframework.amqp" level="WARN" additivity="false">
    <appender-ref ref="CONSOLE"/>
  </logger>
  <logger name="com.rabbitmq" level="WARN" additivity="false">
    <appender-ref ref="CONSOLE"/>
  </logger>

  <if condition='!"false".equalsIgnoreCase(property("RABBITMQ_LOGGING_ENABLED"))'>
    <then>
      <appender name="RABBIT" class="org.springframework.amqp.rabbit.logback.AmqpAppender">
        <host>${RABBITMQ_HOST:-localhost}</host>
        <port>${RABBITMQ_PORT:-5672}</port>
        <username>${RABBITMQ_DEFAULT_USER:-guest}</username>
        <password>${RABBITMQ_DEFAULT_PASS:-guest}</password>
        <virtualHost>${RABBITMQ_VHOST:-/}</virtualHost>
        <exchangeName>${PH_LOGS_EXCHANGE:-ph.logs}</exchangeName>
        <encoder class="net.logstash.logback.encoder.LogstashEncoder">
          <customFields>{"role":"${roleIdentifier}","swarmId":"${swarmIdentifier}","instanceId":"${instanceIdentifier}"}</customFields>
        </encoder>
      </appender>

      <root level="INFO">
        <appender-ref ref="CONSOLE"/>
        <appender-ref ref="RABBIT"/>
      </root>
    </then>
    <else>
      <root level="INFO">
        <appender-ref ref="CONSOLE"/>
      </root>
    </else>
  </if>
</configuration>
