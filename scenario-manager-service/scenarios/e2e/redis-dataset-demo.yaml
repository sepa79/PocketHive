id: redis-dataset-demo
name: Redis dataset demo (generator + per-customer lists)
description: Seeds Redis with randomised payloads and runs two low-rate data providers that each drain their own list.
template:
  image: swarm-controller:latest
  bees:
    - role: generator
      image: generator:latest
      config:
        outputs:
          type: NONE
        inputs:
          type: SCHEDULER
          scheduler:
            ratePerSec: 5
        worker:
          message:
            bodyType: SIMPLE
            body: |
              {% set cust = eval("#randInt(0,1)==0 ? 'custA' : 'custB'") %}
              {% set card = eval("#randLong('4000000000000000','4999999999999999')") %}
              {"customerCode":"{{ cust }}",
              "accountNumber":"{{ eval('#randInt(10000000,99999999)') }}",
              "cardNumber":"{{ card }}",
              "nonce":"{{ eval('#uuid()') }}"}
        interceptors:
          redisUploader:
            enabled: true
            host: redis
            port: 6379
            phase: AFTER
            sourceStep: LAST
            pushDirection: RPUSH
            routes:
              - match: '"customerCode"\s*:\s*"custA"'
                list: ph:dataset:custa
              - match: '"customerCode"\s*:\s*"custB"'
                list: ph:dataset:custb
            fallbackList: ph:dataset:other
      work: {}

    - role: dataProviderA
      image: generator:latest
      config:
        inputs:
          type: REDIS_DATASET
          redis:
            host: redis
            port: 6379
            listName: ph:dataset:custa
            ratePerSec: 5
        worker:
          message:
            bodyType: SIMPLE
            body: "{{ payload }}"
            headers:
              content-type: application/json
              x-ph-call-id: >
                {{ eval("#randInt(0,99) < 50 ? 'redis-auth' : (#randInt(0,99) < 80 ? 'redis-balance' : 'redis-topup')") }}
      work:
        out: http-build

    - role: dataProviderB
      image: generator:latest
      config:
        inputs:
          type: REDIS_DATASET
          redis:
            host: redis
            port: 6379
            listName: ph:dataset:custb
            ratePerSec: 5
        worker:
          message:
            bodyType: SIMPLE
            body: "{{ payload }}"
            headers:
              content-type: application/json
              x-ph-call-id: >
                {{ eval("#randInt(0,99) < 40 ? 'redis-balance' : (#randInt(0,99) < 80 ? 'redis-topup' : 'redis-auth')") }}
      work:
        out: http-build

    - role: http-builder
      image: http-builder:latest
      config:
        worker:
          templateRoot: /app/http-templates
          serviceId: default
      work:
        in: http-build
        out: proc

    - role: processor
      image: processor:latest
      config:
        baseUrl: "{{ sut.endpoints['default'].baseUrl }}"
      work:
        in: proc
        out: post

    - role: postprocessor
      image: postprocessor:latest
      work:
        in: post
