schemaVersion: "1.0"
capabilitiesVersion: "1.4"
role: processor
image:
  name: processor
  tag: latest
ui:
  label: "Processor"
  color: "#a855f7"
  shape: "diamond"
  abbreviation: "PR"
  hideIo: true
  # HTTP processor configuration model:
  # - mode:
  #     - THREAD_COUNT: cap concurrency per instance to `threadCount` in-flight HTTP calls.
  #       The Rabbit worker adapter uses a bounded executor with no backlog so messages
  #       stay queued in Rabbit when all threads are busy.
  #     - RATE_PER_SEC: pace calls to approximately `ratePerSec` requests per second
  #       across the instance, still honouring `threadCount` as a hard max-in-flight cap.
  #       Pacing delay is not counted in the reported call latency.
  # - threadCount: desired concurrent HTTP calls per worker instance. When there is enough
  #   work available, the processor will maintain up to this many in-flight requests.
  # - ratePerSec: target calls per second in RATE_PER_SEC mode. This is shared across HTTP and TCP
  #   calls so control-plane guards can adjust a single knob regardless of protocol mix.
  # - keepAlive + connectionReuse:
  #     - keepAlive=true, connectionReuse=GLOBAL:
  #         - Shared Apache HttpClient connection pool with up to 200 total / 200 per route
  #           connections (also exposed as httpMaxConnections in runtime status).
  #     - keepAlive=true, connectionReuse=PER_THREAD:
  #         - One keep-alive HttpClient per worker thread, so effective max connections is
  #           ~threadCount.
  #     - keepAlive=false or connectionReuse=NONE:
  #         - No keep-alive; each HTTP call uses a fresh connection and closes it afterwards.
  # - Observability:
  #     - Each call records:
  #         - x-ph-processor-duration-ms: time spent in the HTTP call itself (no pacing delay).
  #         - x-ph-processor-connection-latency-ms: time spent waiting for RATE_PER_SEC pacing.
  #     - Runtime status includes:
  #         - httpMode, httpThreadCount, httpMaxConnections, transactions, successRatio,
  #           avgLatencyMs (average HTTP call latency).
config:
  - name: inputs.type
    type: string
    default: "RABBITMQ"
    options:
      - "RABBITMQ"
      - "REDIS_DATASET"
    ui:
      label: Input type
      group: IO
  - name: outputs.type
    type: string
    default: "RABBITMQ"
    options:
      - "RABBITMQ"
      - "REDIS"
      - "NOOP"
    ui:
      label: Output type
      group: IO
  - name: enabled
    type: boolean
    default: false
    ui:
      label: Enabled
      group: General
  - name: baseUrl
    type: string
    default: ""
    ui:
      label: Base URL
      group: HTTP
  - name: mode
    type: string
    default: "THREAD_COUNT"
    options:
      - "THREAD_COUNT"
      - "RATE_PER_SEC"
    ui:
      label: Mode
      group: HTTP
  - name: threadCount
    type: int
    default: 1
    ui:
      label: Thread count
      group: HTTP
  - name: ratePerSec
    type: number
    default: 1.0
    when:
      mode: "RATE_PER_SEC"
    ui:
      label: Rate
      group: HTTP
  - name: keepAlive
    type: boolean
    default: true
    ui:
      label: Keep-alive
      group: HTTP
  - name: connectionReuse
    type: string
    default: "GLOBAL"
    options:
      - "GLOBAL"
      - "PER_THREAD"
      - "NONE"
    ui:
      label: Connection reuse
      group: HTTP
  - name: timeoutMs
    type: int
    default: 30000
  - name: sslVerify
    type: boolean
    default: false
  - name: tcpTransport.type
    type: string
    default: "socket"
    options:
      - "socket"
      - "nio"
      - "netty"
    ui:
      label: Transport type
      group: TCP
  - name: tcpTransport.timeout
    type: int
    default: 30000
    ui:
      label: Timeout (ms)
      group: TCP
  - name: tcpTransport.maxBytes
    type: int
    default: 8192
    ui:
      label: Max bytes
      group: TCP
  - name: tcpTransport.keepAlive
    type: boolean
    default: true
    ui:
      label: Keep-alive
      group: TCP
  - name: tcpTransport.workerThreads
    type: int
    default: 4
    ui:
      label: Worker threads
      group: TCP
  - name: tcpTransport.tcpNoDelay
    type: boolean
    default: true
    ui:
      label: TCP no-delay
      group: TCP
  - name: tcpTransport.sslVerify
    type: boolean
    default: false
    ui:
      label: SSL verify
      group: TCP
  - name: tcpTransport.connectionReuse
    type: string
    default: "GLOBAL"
    options:
      - "GLOBAL"
      - "PER_THREAD"
      - "NONE"
    ui:
      label: Connection reuse
      group: TCP
  - name: tcpTransport.maxRetries
    type: int
    default: 3
    ui:
      label: Max retries
      group: TCP
  - name: tcpTransport.connectTimeoutMs
    type: int
    default: 5000
    ui:
      label: Connect timeout (ms)
      group: TCP
  - name: tcpTransport.readTimeoutMs
    type: int
    default: 30000
    ui:
      label: Read timeout (ms)
      group: TCP
  - name: tcpTransport.ssl.enabled
    type: boolean
    default: false
    ui:
      label: SSL enabled
      group: TCP
  - name: tcpTransport.ssl.verifyHostname
    type: boolean
    default: true
    ui:
      label: SSL verify hostname
      group: TCP
actions: []
panels: []
