{
  "uid": "pockethive-journals",
  "title": "PocketHive Journals",
  "schemaVersion": 39,
  "version": 1,
  "refresh": "30s",
  "style": "dark",
  "tags": ["pockethive", "journal", "runs"],
  "time": { "from": "now-30d", "to": "now" },
  "templating": {
    "list": [
      {
        "type": "textbox",
        "name": "scenarioId",
        "label": "Scenario ID",
        "current": { "text": "", "value": "", "selected": true },
        "hide": 0
      },
      {
        "type": "textbox",
        "name": "testPlan",
        "label": "Test plan",
        "current": { "text": "", "value": "", "selected": true },
        "hide": 0
      },
      {
        "type": "textbox",
        "name": "tag",
        "label": "Tag",
        "current": { "text": "", "value": "", "selected": true },
        "hide": 0
      }
    ]
  },
  "panels": [
    {
      "type": "table",
      "title": "Swarm runs (latest first)",
      "datasource": "PocketHive Journal (Postgres)",
      "id": 1,
      "gridPos": { "h": 20, "w": 24, "x": 0, "y": 0 },
      "targets": [
        {
          "refId": "A",
          "format": "table",
          "rawQuery": true,
          "datasource": "PocketHive Journal (Postgres)",
          "rawSql": "SELECT\n  jr.run_id,\n  jr.swarm_id,\n  jr.scenario_id,\n  jr.test_plan,\n  jr.description,\n  jr.tags,\n  agg.first_ts,\n  agg.last_ts,\n  agg.entries,\n  agg.errors,\n  agg.warns,\n  cap.mode AS pinned_mode\nFROM journal_run jr\nLEFT JOIN LATERAL (\n  SELECT\n    MIN(ts) AS first_ts,\n    MAX(ts) AS last_ts,\n    COUNT(*) AS entries,\n    COUNT(*) FILTER (WHERE severity = 'ERROR') AS errors,\n    COUNT(*) FILTER (WHERE severity = 'WARN') AS warns\n  FROM journal_event je\n  WHERE je.scope = 'SWARM'\n    AND je.swarm_id = jr.swarm_id\n    AND je.run_id = jr.run_id\n) agg ON TRUE\nLEFT JOIN LATERAL (\n  SELECT mode\n  FROM journal_capture jc\n  WHERE jc.scope = 'SWARM'\n    AND jc.swarm_id = jr.swarm_id\n    AND jc.run_id = jr.run_id\n    AND jc.pinned = TRUE\n  ORDER BY jc.created_at DESC\n  LIMIT 1\n) cap ON TRUE\nWHERE ('${scenarioId}' = '' OR jr.scenario_id = '${scenarioId}')\n  AND ('${testPlan}' = '' OR jr.test_plan = '${testPlan}')\n  AND ('${tag}' = '' OR COALESCE(jr.tags ? '${tag}', FALSE))\nORDER BY agg.last_ts DESC NULLS LAST, jr.updated_at DESC\nLIMIT 2000"
        }
      ],
      "options": {
        "showHeader": true,
        "sortBy": [{ "displayName": "last_ts", "desc": true }]
      },
      "fieldConfig": {
        "defaults": {},
        "overrides": [
          {
            "matcher": { "id": "byName", "options": "run_id" },
            "properties": [
              {
                "id": "links",
                "value": [
                  {
                    "title": "Open journal (UI)",
                    "url": "../../../../journal/swarms/${__data.fields[\"swarm_id\"]}?runId=${__value.raw}"
                  },
                  {
                    "title": "Open logs (Grafana)",
                    "url": "/grafana/d/pockethive-logs/pockethive-logs?var-swarmId=${__data.fields[\"swarm_id\"]}"
                  },
                  {
                    "title": "Open logs (runId search)",
                    "url": "/grafana/d/pockethive-logs/pockethive-logs?var-swarmId=${__data.fields[\"swarm_id\"]}&var-search=${__value.raw}"
                  }
                ]
              }
            ]
          },
          {
            "matcher": { "id": "byName", "options": "swarm_id" },
            "properties": [
              {
                "id": "links",
                "value": [
                  {
                    "title": "Open swarm (UI)",
                    "url": "../../../../journal/swarms/${__value.raw}"
                  },
                  {
                    "title": "Open logs (Grafana)",
                    "url": "/grafana/d/pockethive-logs/pockethive-logs?var-swarmId=${__value.raw}"
                  }
                ]
              }
            ]
          }
        ]
      }
    }
  ]
}
