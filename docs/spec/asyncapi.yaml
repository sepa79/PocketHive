asyncapi: 2.6.0
info:
  title: PocketHive Control & Traffic API
  version: 0.6.0
  description: "AsyncAPI specification documenting PocketHive messaging contracts.\n\
    - ph.control \u2014 swarm-aware control plane covering signals (commands) and event streams (outcomes, metrics, alerts).\n\
    - Signals publish with routing keys `signal.<type>.<swarmId>.<role>.<instance>`.\n\
    - All non-signal messages publish with routing keys `event.<category>.<name>.<swarmId>.<role>.<instance>` (for example `event.outcome.swarm-start.*`, `event.metric.status-full.*`, `event.alert.alert.*`).\n\
    - ph.{swarmId}.hive \u2014 traffic exchange for workload messages (generator \u2192 moderator \u2192 processor).\n"
servers:
  control-ws:
    url: ws://{host}/ws
    protocol: stomp
    description: Web-STOMP endpoint proxied by UI (use wss on HTTPS)
    variables:
      host:
        default: localhost:8088
  amqp:
    url: amqp://{host}:{port}
    protocol: amqp
    variables:
      host:
        default: rabbitmq
      port:
        default: '5672'
defaultContentType: application/json
channels:
  exchange/ph.control/signal.{type}.{swarm}.{role}.{instance}:
    parameters:
      type:
        description: Command name (kebab-case)
        schema:
          type: string
          enum:
          - swarm-template
          - swarm-plan
          - swarm-start
          - swarm-stop
          - swarm-remove
          - config-update
          - status-request
      swarm:
        description: Target swarm identifier (or ALL for wildcard fan-out)
        schema:
          type: string
      role:
        description: "Target role (or ALL for wildcard fan-out). This field is intentionally not an enum: roles are flexible."
        schema:
          type: string
      instance:
        description: Target instance identifier (or ALL for wildcard fan-out)
        schema:
          type: string
    publish:
      summary: PocketHive control-plane signals published to swarms, roles, or instances
      message:
        $ref: '#/components/messages/ControlSignal'
    bindings:
      amqp:
        is: routingKey
        exchange:
          name: ph.control
          type: topic
          durable: true
        routingKey: signal.{type}.{swarm}.{role}.{instance}

  exchange/ph.control/event.outcome.{type}.{swarm}.{role}.{instance}:
    parameters:
      type:
        description: Command name that this outcome corresponds to
        schema:
          type: string
          enum:
          - swarm-create
          - swarm-template
          - swarm-plan
          - swarm-start
          - swarm-stop
          - swarm-remove
          - config-update
          - status-request
          - swarm-controller
      swarm:
        description: Swarm context for the outcome (or ALL for wildcard fan-out)
        schema:
          type: string
      role:
        description: "Role affected by the outcome (or ALL for wildcard fan-out). This field is intentionally not an enum: roles are flexible."
        schema:
          type: string
      instance:
        description: Specific instance that produced the outcome (or ALL for wildcard fan-out)
        schema:
          type: string
    subscribe:
      summary: Outcomes emitted for control-plane commands (success and error)
      message:
        $ref: '#/components/messages/CommandOutcome'
    bindings:
      amqp:
        is: routingKey
        exchange:
          name: ph.control
          type: topic
          durable: true
        routingKey: event.outcome.{type}.{swarm}.{role}.{instance}

  exchange/ph.control/event.metric.{type}.{swarm}.{role}.{instance}:
    parameters:
      type:
        description: Metric type
        schema:
          type: string
          enum:
          - status-full
          - status-delta
      swarm:
        description: Swarm emitting the metric sample
        schema:
          type: string
      role:
        description: "Role emitting the metric sample. This field is intentionally not an enum: roles are flexible."
        schema:
          type: string
      instance:
        description: Instance emitting the metric sample
        schema:
          type: string
    subscribe:
      summary: Metric streams from controllers and workers
      message:
        oneOf:
        - $ref: '#/components/messages/ControlMetricStatusFull'
        - $ref: '#/components/messages/ControlMetricStatusDelta'
    bindings:
      amqp:
        is: routingKey
        exchange:
          name: ph.control
          type: topic
          durable: true
        routingKey: event.metric.{type}.{swarm}.{role}.{instance}

  exchange/ph.control/event.alert.alert.{swarm}.{role}.{instance}:
    parameters:
      swarm:
        description: Swarm emitting the alert
        schema:
          type: string
      role:
        description: "Role emitting the alert. This field is intentionally not an enum: roles are flexible."
        schema:
          type: string
      instance:
        description: Instance emitting the alert
        schema:
          type: string
    subscribe:
      summary: Alert notifications emitted across the control plane
      message:
        $ref: '#/components/messages/AlertMessage'
    bindings:
      amqp:
        is: routingKey
        exchange:
          name: ph.control
          type: topic
          durable: true
        routingKey: event.alert.alert.{swarm}.{role}.{instance}
components:
  messages:
    ControlSignal:
      name: ControlSignal
      title: "Control \u2014 Signal"
      contentType: application/json
      payload:
        $ref: '#/components/schemas/ControlSignalPayload'
    CommandOutcome:
      name: CommandOutcome
      title: "Control \u2014 Outcome"
      contentType: application/json
      payload:
        $ref: '#/components/schemas/CommandOutcomePayload'
    ControlMetricStatusFull:
      name: ControlMetricStatusFull
      title: "Control \u2014 Metric (status-full)"
      contentType: application/json
      payload:
        $ref: '#/components/schemas/ControlMetricStatusFullPayload'
    ControlMetricStatusDelta:
      name: ControlMetricStatusDelta
      title: "Control \u2014 Metric (status-delta)"
      contentType: application/json
      payload:
        $ref: '#/components/schemas/ControlMetricStatusDeltaPayload'
    AlertMessage:
      name: AlertMessage
      title: "Control \u2014 Alert"
      contentType: application/json
      payload:
        $ref: '#/components/schemas/AlertMessagePayload'
  schemas:
    NonEmptyString:
      type: string
      minLength: 1
    NullableNonEmptyString:
      oneOf:
      - $ref: '#/components/schemas/NonEmptyString'
      - type: 'null'
    EnvelopeScope:
      type: object
      required:
      - swarmId
      - role
      - instance
      additionalProperties: false
      properties:
        swarmId:
          type:
          - string
          - 'null'
        role:
          type:
          - string
          - 'null'
        instance:
          type:
          - string
          - 'null'
    EnvelopeBase:
      type: object
      additionalProperties: false
      required:
      - timestamp
      - version
      - kind
      - type
      - origin
      - scope
      - correlationId
      - idempotencyKey
      - data
      properties:
        timestamp:
          type: string
          format: date-time
          description: RFC-3339 time when the message was emitted by its origin.
        version:
          $ref: '#/components/schemas/NonEmptyString'
          description: Schema version for this envelope and its structured data section.
        kind:
          $ref: '#/components/schemas/NonEmptyString'
          description: Coarse message category (signal, outcome, metric, event).
        type:
          $ref: '#/components/schemas/NonEmptyString'
          description: Concrete name within the kind (command name, metric type, event type).
        origin:
          $ref: '#/components/schemas/NonEmptyString'
          description: Logical emitter identity (instance id or UI client id).
        scope:
          $ref: '#/components/schemas/EnvelopeScope'
        correlationId:
          $ref: '#/components/schemas/NullableNonEmptyString'
        idempotencyKey:
          $ref: '#/components/schemas/NullableNonEmptyString'
        data:
          description: Structured payload whose schema is defined per (kind, type).
          type:
          - object
          - 'null'
          additionalProperties: true
    ControlSignalPayload:
      allOf:
      - $ref: '#/components/schemas/EnvelopeBase'
      - type: object
        additionalProperties: false
        properties:
          kind:
            const: signal
          type:
            $ref: '#/components/schemas/NonEmptyString'
            description: Command name (swarm-start, config-update, swarm-stop, ...).
          correlationId:
            $ref: '#/components/schemas/NonEmptyString'
            description: Correlation token for this command attempt.
          data:
            type: object
            additionalProperties: true
            description: Command-specific arguments.
    CommandOutcomePayload:
      type: object
      additionalProperties: false
      required:
      - timestamp
      - version
      - kind
      - type
      - origin
      - scope
      - correlationId
      - idempotencyKey
      - data
      properties:
        timestamp:
          type: string
          format: date-time
        version:
          $ref: '#/components/schemas/NonEmptyString'
        kind:
          type: string
          enum: [outcome]
        type:
          $ref: '#/components/schemas/NonEmptyString'
          description: Command name that produced this outcome.
        origin:
          $ref: '#/components/schemas/NonEmptyString'
          description: Concrete emitter instance id.
        scope:
          $ref: '#/components/schemas/EnvelopeScope'
          description: Scope tuple describing the concrete subject that processed the command.
        correlationId:
          $ref: '#/components/schemas/NonEmptyString'
        idempotencyKey:
          $ref: '#/components/schemas/NullableNonEmptyString'
        data:
          type: object
          additionalProperties: true
          required:
          - status
          properties:
            status:
              $ref: '#/components/schemas/NonEmptyString'
              description: High-level status after processing the command (Ready, Running, Stopped, ...).
            enabled:
              type: boolean
              description: Optional enablement outcome (only meaningful for config-update).
            retryable:
              type: boolean
              description: Optional retry hint for failures.
            context:
              type: object
              additionalProperties: true
              description: Optional structured context for journal/debug (must not contain stack traces).
    QueueStatsEntry:
      type: object
      additionalProperties: false
      required:
      - depth
      - consumers
      properties:
        depth:
          type: integer
          minimum: 0
        consumers:
          type: integer
          minimum: 0
        oldestAgeSec:
          type: number
          minimum: 0
    MetricIoQueues:
      type: object
      additionalProperties: false
      properties:
        in:
          type: array
          items:
            type: string
        out:
          type: array
          items:
            type: string
        routes:
          type: array
          items:
            type: string
    MetricIoWork:
      type: object
      additionalProperties: false
      properties:
        queues:
          $ref: '#/components/schemas/MetricIoQueues'
        queueStats:
          type: object
          description: Runtime depth/consumer metrics keyed by queue name.
          additionalProperties:
            $ref: '#/components/schemas/QueueStatsEntry'
    MetricIoControl:
      type: object
      additionalProperties: false
      properties:
        queues:
          $ref: '#/components/schemas/MetricIoQueues'
    MetricIo:
      type: object
      additionalProperties: false
      properties:
        work:
          $ref: '#/components/schemas/MetricIoWork'
        control:
          $ref: '#/components/schemas/MetricIoControl'
    IoInputState:
      type: string
      enum:
      - ok
      - out-of-data
      - backpressure
      - upstream-error
      - unknown
    IoOutputState:
      type: string
      enum:
      - ok
      - blocked
      - throttled
      - downstream-error
      - unknown
    IoState:
      type: object
      additionalProperties: false
      required:
      - input
      - output
      properties:
        input:
          $ref: '#/components/schemas/IoInputState'
        output:
          $ref: '#/components/schemas/IoOutputState'
        context:
          type: object
          additionalProperties: true
    MetricIoState:
      type: object
      additionalProperties: false
      properties:
        work:
          $ref: '#/components/schemas/IoState'
        control:
          $ref: '#/components/schemas/IoState'
    ControlMetricStatusFullPayload:
      allOf:
      - $ref: '#/components/schemas/EnvelopeBase'
      - type: object
        additionalProperties: false
        properties:
          kind:
            const: metric
          type:
            const: status-full
          data:
            type: object
            additionalProperties: false
            required:
            - enabled
            - config
            - tps
            - startedAt
            - io
            - ioState
            properties:
              enabled:
                type: boolean
              config:
                type: object
                additionalProperties: true
                description: "Snapshot of the effective configuration for this scope (role/instance). Must not include secrets."
              tps:
                type: integer
                minimum: 0
              startedAt:
                type: string
                format: date-time
              io:
                $ref: '#/components/schemas/MetricIo'
              ioState:
                $ref: '#/components/schemas/MetricIoState'
              context:
                type: object
                additionalProperties: true
    ControlMetricStatusDeltaPayload:
      allOf:
      - $ref: '#/components/schemas/EnvelopeBase'
      - type: object
        additionalProperties: false
        properties:
          kind:
            const: metric
          type:
            const: status-delta
          data:
            type: object
            additionalProperties: false
            required:
            - enabled
            - tps
            - ioState
            properties:
              enabled:
                type: boolean
              tps:
                type: integer
                minimum: 0
              ioState:
                $ref: '#/components/schemas/MetricIoState'
              context:
                type: object
                additionalProperties: true
    AlertMessagePayload:
      allOf:
      - $ref: '#/components/schemas/EnvelopeBase'
      - type: object
        additionalProperties: false
        properties:
          kind:
            const: event
          type:
            const: alert
          data:
            type: object
            additionalProperties: false
            required:
            - level
            - code
            - message
            properties:
              level:
                type: string
                enum:
                - info
                - warn
                - error
              code:
                $ref: '#/components/schemas/NonEmptyString'
              message:
                $ref: '#/components/schemas/NonEmptyString'
              errorType:
                $ref: '#/components/schemas/NullableNonEmptyString'
              errorDetail:
                $ref: '#/components/schemas/NullableNonEmptyString'
              logRef:
                $ref: '#/components/schemas/NullableNonEmptyString'
              context:
                type: object
                additionalProperties: true
