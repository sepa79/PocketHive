asyncapi: 2.6.0
info:
  title: PocketHive Control & Traffic API
  version: 0.6.0
  description: "AsyncAPI specification documenting PocketHive messaging contracts.\n\
    - ph.control \u2014 swarm-aware control plane covering signals (commands) and event streams (outcomes, metrics, alerts).\n\
    - Signals publish with routing keys `signal.<type>.<swarmId>.<role>.<instance>`.\n\
    - All non-signal messages publish with routing keys `event.<category>.<name>.<swarmId>.<role>.<instance>` (for example `event.outcome.swarm-start.*`, `event.metric.status-full.*`, `event.alert.alert.*`).\n\
    - ph.{swarmId}.hive \u2014 traffic exchange for workload messages (generator \u2192 moderator \u2192 processor).\n"
servers:
  control-ws:
    url: ws://{host}/ws
    protocol: stomp
    description: Web-STOMP endpoint proxied by UI (use wss on HTTPS)
    variables:
      host:
        default: localhost:8088
  amqp:
    url: amqp://{host}:{port}
    protocol: amqp
    variables:
      host:
        default: rabbitmq
      port:
        default: '5672'
defaultContentType: application/json
channels:
  exchange/ph.control/signal.{type}.{swarm}.{role}.{instance}:
    parameters:
      type:
        description: Command name (kebab-case)
        schema:
          type: string
          enum:
          - swarm-template
          - swarm-plan
          - swarm-start
          - swarm-stop
          - swarm-remove
          - config-update
          - status-request
      swarm:
        description: Target swarm identifier (or ALL for wildcard fan-out)
        schema:
          type: string
      role:
        description: "Target role (or ALL for wildcard fan-out). This field is intentionally not an enum: roles are flexible."
        schema:
          type: string
      instance:
        description: Target instance identifier (or ALL for wildcard fan-out)
        schema:
          type: string
    publish:
      summary: PocketHive control-plane signals published to swarms, roles, or instances
      message:
        $ref: '#/components/messages/ControlSignal'
    bindings:
      amqp:
        is: routingKey
        exchange:
          name: ph.control
          type: topic
          durable: true
        routingKey: signal.{type}.{swarm}.{role}.{instance}

  exchange/ph.control/event.outcome.{type}.{swarm}.{role}.{instance}:
    parameters:
      type:
        description: Command name that this outcome corresponds to
        schema:
          type: string
          enum:
          - swarm-create
          - swarm-template
          - swarm-plan
          - swarm-start
          - swarm-stop
          - swarm-remove
          - config-update
          - status-request
          - swarm-controller
      swarm:
        description: Swarm context for the outcome (or ALL for wildcard fan-out)
        schema:
          type: string
      role:
        description: "Role affected by the outcome (or ALL for wildcard fan-out). This field is intentionally not an enum: roles are flexible."
        schema:
          type: string
      instance:
        description: Specific instance that produced the outcome (or ALL for wildcard fan-out)
        schema:
          type: string
    subscribe:
      summary: Outcomes emitted for control-plane commands (success and error)
      message:
        $ref: '#/components/messages/CommandOutcome'
    bindings:
      amqp:
        is: routingKey
        exchange:
          name: ph.control
          type: topic
          durable: true
        routingKey: event.outcome.{type}.{swarm}.{role}.{instance}

  exchange/ph.control/event.metric.{type}.{swarm}.{role}.{instance}:
    parameters:
      type:
        description: Metric type
        schema:
          type: string
          enum:
          - status-full
          - status-delta
      swarm:
        description: Swarm emitting the metric sample
        schema:
          type: string
      role:
        description: "Role emitting the metric sample. This field is intentionally not an enum: roles are flexible."
        schema:
          type: string
      instance:
        description: Instance emitting the metric sample
        schema:
          type: string
    subscribe:
      summary: Metric streams from controllers and workers
      message:
        oneOf:
        - $ref: '#/components/messages/ControlMetricStatusFull'
        - $ref: '#/components/messages/ControlMetricStatusDelta'
    bindings:
      amqp:
        is: routingKey
        exchange:
          name: ph.control
          type: topic
          durable: true
        routingKey: event.metric.{type}.{swarm}.{role}.{instance}

  exchange/ph.control/event.alert.alert.{swarm}.{role}.{instance}:
    parameters:
      swarm:
        description: Swarm emitting the alert
        schema:
          type: string
      role:
        description: "Role emitting the alert. This field is intentionally not an enum: roles are flexible."
        schema:
          type: string
      instance:
        description: Instance emitting the alert
        schema:
          type: string
    subscribe:
      summary: Alert notifications emitted across the control plane
      message:
        $ref: '#/components/messages/AlertMessage'
    bindings:
      amqp:
        is: routingKey
        exchange:
          name: ph.control
          type: topic
          durable: true
        routingKey: event.alert.alert.{swarm}.{role}.{instance}
components:
  messages:
    ControlSignal:
      name: ControlSignal
      title: "Control \u2014 Signal"
      contentType: application/json
      schemaFormat: application/schema+json;version=draft/2020-12
      payload:
        $ref: './control-events.schema.json#/$defs/ControlSignal'
    CommandOutcome:
      name: CommandOutcome
      title: "Control \u2014 Outcome"
      contentType: application/json
      schemaFormat: application/schema+json;version=draft/2020-12
      payload:
        $ref: './control-events.schema.json#/$defs/CommandOutcome'
    ControlMetricStatusFull:
      name: ControlMetricStatusFull
      title: "Control \u2014 Metric (status-full)"
      contentType: application/json
      schemaFormat: application/schema+json;version=draft/2020-12
      payload:
        $ref: './control-events.schema.json#/$defs/StatusFullMetric'
    ControlMetricStatusDelta:
      name: ControlMetricStatusDelta
      title: "Control \u2014 Metric (status-delta)"
      contentType: application/json
      schemaFormat: application/schema+json;version=draft/2020-12
      payload:
        $ref: './control-events.schema.json#/$defs/StatusDeltaMetric'
    AlertMessage:
      name: AlertMessage
      title: "Control \u2014 Alert"
      contentType: application/json
      schemaFormat: application/schema+json;version=draft/2020-12
      payload:
        $ref: './control-events.schema.json#/$defs/AlertEvent'
  # Payload schemas live in `docs/spec/control-events.schema.json` (SSOT).
  schemas: {}
