{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://pockethive.dev/docs/spec/control-events.schema.json",
  "title": "PocketHive Control-Plane Envelope",
  "type": "object",
  "oneOf": [
    { "$ref": "#/$defs/ControlSignal" },
    { "$ref": "#/$defs/CommandOutcome" },
    { "$ref": "#/$defs/StatusFullMetric" },
    { "$ref": "#/$defs/StatusDeltaMetric" },
    { "$ref": "#/$defs/AlertEvent" }
  ],
  "$defs": {
    "NonEmptyString": {
      "type": "string",
      "minLength": 1
    },
    "NullableNonEmptyString": {
      "oneOf": [
        { "$ref": "#/$defs/NonEmptyString" },
        { "type": "null" }
      ]
    },
    "Scope": {
      "type": "object",
      "additionalProperties": false,
      "required": ["swarmId", "role", "instance"],
      "properties": {
        "swarmId": { "$ref": "#/$defs/NonEmptyString" },
        "role": { "$ref": "#/$defs/NonEmptyString" },
        "instance": { "$ref": "#/$defs/NonEmptyString" }
      },
      "description": "Scope tuple (swarmId/role/instance) that mirrors the routing-key target segments. Use the literal ALL for fan-out; values must never be null."
    },
    "EnvelopeBase": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "timestamp",
        "version",
        "kind",
        "type",
        "origin",
        "scope",
        "correlationId",
        "idempotencyKey",
        "data"
      ],
      "properties": {
        "timestamp": { "type": "string", "format": "date-time" },
        "version": { "$ref": "#/$defs/NonEmptyString" },
        "kind": { "$ref": "#/$defs/NonEmptyString" },
        "type": { "$ref": "#/$defs/NonEmptyString" },
        "origin": { "$ref": "#/$defs/NonEmptyString" },
        "scope": { "$ref": "#/$defs/Scope" },
        "correlationId": { "$ref": "#/$defs/NullableNonEmptyString" },
        "idempotencyKey": { "$ref": "#/$defs/NullableNonEmptyString" },
        "data": {
          "type": "object",
          "additionalProperties": true
        }
      }
    },
    "ControlSignal": {
      "allOf": [
        { "$ref": "#/$defs/EnvelopeBase" },
        {
          "type": "object",
          "properties": {
            "kind": { "const": "signal" },
            "correlationId": { "$ref": "#/$defs/NonEmptyString" },
            "data": { "type": "object", "additionalProperties": true }
          }
        }
      ]
    },
    "CommandOutcome": {
      "allOf": [
        { "$ref": "#/$defs/EnvelopeBase" },
        {
          "type": "object",
          "properties": {
            "kind": { "const": "outcome" },
            "correlationId": { "$ref": "#/$defs/NonEmptyString" },
            "data": {
              "type": "object",
              "additionalProperties": true,
              "required": ["status"],
              "properties": {
                "status": { "$ref": "#/$defs/NonEmptyString" },
                "enabled": { "type": "boolean" },
                "retryable": { "type": "boolean" },
                "context": { "type": "object", "additionalProperties": true }
              }
            }
          }
        }
      ]
    },
    "QueueStatsEntry": {
      "type": "object",
      "additionalProperties": false,
      "required": ["depth", "consumers"],
      "properties": {
        "depth": { "type": "integer", "minimum": 0 },
        "consumers": { "type": "integer", "minimum": 0 },
        "oldestAgeSec": { "type": "number", "minimum": 0 }
      }
    },
    "MetricIoQueues": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "in": { "type": "array", "items": { "type": "string" } },
        "out": { "type": "array", "items": { "type": "string" } },
        "routes": { "type": "array", "items": { "type": "string" } }
      }
    },
    "MetricIoWork": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "queues": { "$ref": "#/$defs/MetricIoQueues" },
        "queueStats": {
          "type": "object",
          "additionalProperties": { "$ref": "#/$defs/QueueStatsEntry" }
        }
      }
    },
    "MetricIoControl": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "queues": { "$ref": "#/$defs/MetricIoQueues" }
      }
    },
    "MetricIo": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "work": { "$ref": "#/$defs/MetricIoWork" },
        "control": { "$ref": "#/$defs/MetricIoControl" }
      }
    },
    "IoInputState": {
      "type": "string",
      "enum": ["ok", "out-of-data", "backpressure", "upstream-error", "unknown"]
    },
    "IoOutputState": {
      "type": "string",
      "enum": ["ok", "blocked", "throttled", "downstream-error", "unknown"]
    },
    "IoState": {
      "type": "object",
      "additionalProperties": false,
      "required": ["input", "output"],
      "properties": {
        "input": { "$ref": "#/$defs/IoInputState" },
        "output": { "$ref": "#/$defs/IoOutputState" },
        "context": { "type": "object", "additionalProperties": true }
      }
    },
    "MetricIoState": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "work": { "$ref": "#/$defs/IoState" },
        "filesystem": { "$ref": "#/$defs/IoState" }
      }
    },
    "RuntimeMeta": {
      "type": "object",
      "additionalProperties": false,
      "description": "Runtime/infra metadata for this scope (full-only).",
      "required": ["templateId"],
      "properties": {
        "templateId": { "$ref": "#/$defs/NonEmptyString" },
        "runId": { "$ref": "#/$defs/NullableNonEmptyString" },
        "containerId": { "$ref": "#/$defs/NullableNonEmptyString" },
        "image": { "$ref": "#/$defs/NullableNonEmptyString" },
        "stackName": { "$ref": "#/$defs/NullableNonEmptyString" }
      }
    },
    "StatusFullMetric": {
      "allOf": [
        { "$ref": "#/$defs/EnvelopeBase" },
        {
          "type": "object",
          "properties": {
            "kind": { "const": "metric" },
            "type": { "const": "status-full" },
                "data": {
                  "type": "object",
                  "additionalProperties": false,
                  "required": ["enabled", "config", "startedAt", "runtime", "io", "ioState"],
                  "properties": {
                    "enabled": { "type": "boolean" },
                    "config": {
                      "type": "object",
                      "additionalProperties": true,
                      "description": "Snapshot of the effective configuration for this scope (role/instance). Must not include secrets."
                    },
                    "runtime": { "$ref": "#/$defs/RuntimeMeta" },
                    "tps": { "type": "integer", "minimum": 0 },
                    "startedAt": { "type": "string", "format": "date-time" },
                    "io": { "$ref": "#/$defs/MetricIo" },
                    "ioState": { "$ref": "#/$defs/MetricIoState" },
                    "context": { "type": "object", "additionalProperties": true }
                  }
            }
          }
        }
      ]
    },
    "StatusDeltaMetric": {
      "allOf": [
        { "$ref": "#/$defs/EnvelopeBase" },
        {
          "type": "object",
          "properties": {
            "kind": { "const": "metric" },
            "type": { "const": "status-delta" },
                "data": {
                  "type": "object",
                  "additionalProperties": false,
                  "required": ["enabled", "ioState"],
                  "properties": {
                    "enabled": { "type": "boolean" },
                    "tps": { "type": "integer", "minimum": 0 },
                    "ioState": { "$ref": "#/$defs/MetricIoState" },
                    "context": { "type": "object", "additionalProperties": true }
                  }
                }
              }
        }
      ]
    },
    "AlertEvent": {
      "allOf": [
        { "$ref": "#/$defs/EnvelopeBase" },
        {
          "type": "object",
          "properties": {
            "kind": { "const": "event" },
            "type": { "const": "alert" },
            "data": {
              "type": "object",
              "additionalProperties": false,
              "required": ["level", "code", "message"],
              "properties": {
                "level": { "type": "string", "enum": ["info", "warn", "error"] },
                "code": { "$ref": "#/$defs/NonEmptyString" },
                "message": { "$ref": "#/$defs/NonEmptyString" },
                "errorType": { "$ref": "#/$defs/NullableNonEmptyString" },
                "errorDetail": { "$ref": "#/$defs/NullableNonEmptyString" },
                "logRef": { "$ref": "#/$defs/NullableNonEmptyString" },
                "context": { "type": "object", "additionalProperties": true }
              }
            }
          }
        }
      ]
    }
  }
}
